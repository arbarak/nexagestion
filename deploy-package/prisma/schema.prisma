// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// GROUP & COMPANY MANAGEMENT
// ============================================================================

model Group {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies Company[]
  clients   Client[]
  suppliers Supplier[]
  products  Product[]
  services  Service[]
  categories Category[]
  brands    Brand[]
  taxRates  TaxRate[]

  @@map("groups")
}

model Company {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String   @unique
  ice       String?  // Identifiant Commun de l'Entreprise
  if        String?  // Identifiant Fiscal
  rc        String?  // Registre de Commerce
  patente   String?  // Patente
  cnss      String?  // Caisse Nationale de Sécurité Sociale
  address   String?
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  users     User[]
  employees Employee[]
  boats      Boat[]
  sales      Sale[]
  purchases Purchase[]
  stocks    Stock[]
  payments  Payment[]
  accounts  Account[]
  journalEntries JournalEntry[]
  customReports CustomReport[]
  workflows Workflow[]
  tasks     Task[]
  approvals Approval[]
  automationRules AutomationRule[]
  securityAuditLogs SecurityAuditLog[]
  complianceRequirements ComplianceRequirement[]
  backups   Backup[]
  restores  Restore[]
  aiPredictions AIPrediction[]
  aiRecommendations AIRecommendation[]
  aiAnomalies AIAnomaly[]
  aiConversations AIConversation[]
  systemMetrics SystemMetric[]
  deploymentRecords DeploymentRecord[]
  backupRecords BackupRecord[]
  collaborationDocuments CollaborationDocument[]
  teamChatChannels TeamChatChannel[]
  tags Tag[]
  searchIndexes SearchIndex[]

  @@unique([groupId, code])
  @@map("companies")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(VIEWER)
  companyId String?
  twoFactorEnabled Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company       Company?        @relation(fields: [companyId], references: [id], onDelete: SetNull)
  sessions      Session[]
  notifications Notification[]
  auditLogs     AuditLog[]
  customReports CustomReport[]
  workflows     Workflow[]
  tasksAssigned Task[]          @relation("TaskAssignee")
  tasksCreated  Task[]          @relation("TaskCreator")
  approvalsRequested Approval[]
  automationRules AutomationRule[]
  twoFactorAuths TwoFactorAuth[]
  passwordResets PasswordReset[]
  securityAuditLogs SecurityAuditLog[]
  complianceRequirements ComplianceRequirement[]
  backups       Backup[]
  restores      Restore[]
  deviceTokens  DeviceToken[]
  aiPredictions AIPrediction[]
  aiRecommendations AIRecommendation[]
  aiAnomalies AIAnomaly[]
  aiConversations AIConversation[]
  deploymentRecords DeploymentRecord[]
  collaborationDocumentsOwned CollaborationDocument[] @relation("DocumentOwner")
  collaborationComments CollaborationComment[]
  collaborationVersions CollaborationVersion[]
  teamChatMessages TeamChatMessage[]

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

enum Role {
  ADMIN
  MANAGER
  STOCK
  ACCOUNTANT
  VIEWER
}

// ============================================================================
// REFERENTIALS (Shared at Group Level)
// ============================================================================

model Client {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String
  email     String?
  phone     String?
  address   String?
  city      String?
  country   String?
  ice       String?
  if        String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  boats     Boat[]
  sales     Sale[]
  invoices  Invoice[]

  @@unique([groupId, code])
  @@map("clients")
}

model Supplier {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String
  email     String?
  phone     String?
  address   String?
  city      String?
  country   String?
  ice       String?
  if        String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  purchases Purchase[]

  @@unique([groupId, code])
  @@map("suppliers")
}

model Product {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String
  description String?
  categoryId String?
  brandId   String?
  price     Decimal  @db.Decimal(10, 2)
  cost      Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  category  Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  brand     Brand?     @relation(fields: [brandId], references: [id], onDelete: SetNull)
  saleItems SaleItem[]
  purchaseItems PurchaseItem[]
  stocks    Stock[]

  @@unique([groupId, code])
  @@map("products")
}

model Service {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String
  description String?
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  saleItems SaleItem[]

  @@unique([groupId, code])
  @@map("services")
}

model Category {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([groupId, code])
  @@map("categories")
}

model Brand {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([groupId, code])
  @@map("brands")
}

model TaxRate {
  id        String   @id @default(cuid())
  groupId   String
  name      String
  code      String
  rate      Decimal  @db.Decimal(5, 2)
  type      TaxType
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, code])
  @@map("tax_rates")
}

enum TaxType {
  TVA
  TSP
}

// ============================================================================
// MARITIME MODULE
// ============================================================================

model Boat {
  id        String   @id @default(cuid())
  companyId String
  clientId  String
  name      String
  code      String
  type      String?
  length    Decimal? @db.Decimal(8, 2)
  width     Decimal? @db.Decimal(8, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  interventions Intervention[]

  @@unique([companyId, code])
  @@map("boats")
}

model Intervention {
  id        String   @id @default(cuid())
  boatId    String
  type      String   // SATELLITE, TELEPHONE, REPAIR, etc.
  description String?
  startDate DateTime
  endDate   DateTime?
  status    InterventionStatus @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boat Boat @relation(fields: [boatId], references: [id], onDelete: Cascade)

  @@map("interventions")
}

enum InterventionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ============================================================================
// EMPLOYEE MANAGEMENT
// ============================================================================

model Employee {
  id        String   @id @default(cuid())
  companyId String
  firstName String
  lastName  String
  email     String?
  phone     String?
  position  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sessions EmployeeSession[]

  @@map("employees")
}

model EmployeeSession {
  id        String   @id @default(cuid())
  employeeId String
  checkIn   DateTime
  checkOut  DateTime?
  createdAt DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("employee_sessions")
}

// ============================================================================
// SALES & PURCHASES
// ============================================================================

model Sale {
  id        String   @id @default(cuid())
  companyId String
  clientId  String
  number    String
  status    SaleStatus @default(DRAFT)
  totalAmount Decimal @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items   SaleItem[]
  invoice Invoice?

  @@unique([companyId, number])
  @@map("sales")
}

model SaleItem {
  id        String   @id @default(cuid())
  saleId    String
  productId String?
  serviceId String?
  quantity  Decimal  @db.Decimal(10, 2)
  unitPrice Decimal  @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(12, 2)

  sale      Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  service   Service?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@map("sale_items")
}

enum SaleStatus {
  DRAFT
  QUOTE
  ORDER
  DELIVERY
  INVOICED
  PAID
  CANCELLED
}

model Invoice {
  id        String   @id @default(cuid())
  companyId String
  clientId  String
  saleId    String   @unique
  number    String
  status    InvoiceStatus @default(DRAFT)
  totalAmount Decimal @db.Decimal(12, 2)
  taxAmount Decimal @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@unique([companyId, number])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Purchase {
  id        String   @id @default(cuid())
  companyId String
  supplierId String
  number    String
  status    PurchaseStatus @default(DRAFT)
  totalAmount Decimal @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier  Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  items     PurchaseItem[]

  @@unique([companyId, number])
  @@map("purchases")
}

model PurchaseItem {
  id        String   @id @default(cuid())
  purchaseId String
  productId String
  quantity  Decimal  @db.Decimal(10, 2)
  unitPrice Decimal  @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(12, 2)

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("purchase_items")
}

enum PurchaseStatus {
  DRAFT
  ORDER
  RECEIVED
  INVOICED
  PAID
  CANCELLED
}

// ============================================================================
// INVENTORY & STOCK
// ============================================================================

model Stock {
  id        String   @id @default(cuid())
  companyId String
  productId String
  quantity  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  product   Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  movements StockMovement[]

  @@unique([companyId, productId])
  @@map("stocks")
}

model StockMovement {
  id        String   @id @default(cuid())
  stockId   String
  type      MovementType
  quantity  Decimal  @db.Decimal(10, 2)
  reference String?
  createdAt DateTime @default(now())

  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@map("stock_movements")
}

enum MovementType {
  IN
  OUT
  BOAT_OUT
  BOAT_IN
  ADJUSTMENT
}

// ============================================================================
// PAYMENTS & TREASURY
// ============================================================================

model Payment {
  id        String   @id @default(cuid())
  companyId String
  amount    Decimal  @db.Decimal(12, 2)
  type      PaymentType
  status    PaymentStatus @default(PENDING)
  reference String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum PaymentType {
  CASH
  CHECK
  TRANSFER
  CARD
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================================
// FINANCIAL MANAGEMENT
// ============================================================================

model Account {
  id            String   @id @default(cuid())
  groupId       String
  companyId     String
  accountCode   String
  accountName   String
  accountType   String   // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  balance       Float    @default(0)
  currency      String
  status        String   @default("ACTIVE")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactions JournalEntryItem[]
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, accountCode])
  @@map("accounts")
}

model JournalEntry {
  id          String   @id @default(cuid())
  groupId     String
  companyId   String
  entryDate   DateTime
  description String
  reference   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items   JournalEntryItem[]
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("journal_entries")
}

model JournalEntryItem {
  id              String   @id @default(cuid())
  journalEntryId  String
  accountId       String
  debit           Float    @default(0)
  credit          Float    @default(0)
  createdAt       DateTime @default(now())

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("journal_entry_items")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   // INFO, WARNING, ERROR, SUCCESS
  module    String
  relatedId String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================================================
// PERFORMANCE MONITORING
// ============================================================================

model PerformanceMetric {
  id                      String   @id @default(cuid())
  groupId                 String
  companyId               String
  page                    String
  loadTime                Int
  firstContentfulPaint    Int
  largestContentfulPaint  Int
  cumulativeLayoutShift   Float
  timeToInteractive       Int
  userAgent               String?
  createdAt               DateTime @default(now())

  @@index([companyId, createdAt])
  @@map("performance_metrics")
}

// ============================================================================
// INTEGRATIONS & API
// ============================================================================

model ApiKey {
  id          String   @id @default(cuid())
  groupId     String
  companyId   String
  name        String
  key         String   @unique
  permissions String[]
  active      Boolean  @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("api_keys")
}

model Webhook {
  id        String   @id @default(cuid())
  groupId   String
  companyId String
  name      String
  url       String
  events    String[]
  secret    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries WebhookDelivery[]

  @@map("webhooks")
}

model WebhookDelivery {
  id        String   @id @default(cuid())
  webhookId String
  event     String
  payload   Json
  status    String   // SUCCESS, FAILED, PENDING
  response  String?
  createdAt DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_deliveries")
}

// ============================================================================
// AUDIT & LOGGING
// ============================================================================

model AuditLog {
  id        String   @id @default(cuid())
  groupId   String
  companyId String
  userId    String
  action    String
  module    String
  entityType String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// ============================================================================
// ANALYTICS & REPORTING
// ============================================================================

model CustomReport {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  type        String   // sales, inventory, financial, employees
  filters     Json?
  columns     Json     // Array of column names
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([createdBy])
  @@map("custom_reports")
}

// ============================================================================
// WORKFLOW & AUTOMATION
// ============================================================================

model Workflow {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  trigger     String   // manual, order_created, invoice_created, payment_received
  steps       Json     // Array of workflow steps
  enabled     Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("workflows")
}

model Task {
  id            String   @id @default(cuid())
  companyId     String
  title         String
  description   String?
  assignedTo    String
  priority      String   @default("medium") // low, medium, high, urgent
  status        String   @default("todo")   // todo, in_progress, review, completed
  dueDate       DateTime?
  relatedEntity Json?    // { type: string, id: string }
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignee User    @relation("TaskAssignee", fields: [assignedTo], references: [id], onDelete: Cascade)
  creator  User    @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([assignedTo])
  @@map("tasks")
}

model Approval {
  id          String   @id @default(cuid())
  companyId   String
  entityType  String
  entityId    String
  requestedBy String
  approvers   Json     // Array of approver user IDs
  status      String   @default("pending") // pending, approved, rejected
  reason      String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company         Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  requestedByUser User    @relation(fields: [requestedBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@map("approvals")
}

model AutomationRule {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  trigger     Json     // { type: string, conditions: object }
  actions     Json     // Array of actions
  enabled     Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("automation_rules")
}

// ============================================================================
// SECURITY & COMPLIANCE
// ============================================================================

model TwoFactorAuth {
  id        String   @id @default(cuid())
  userId    String
  method    String   // email, sms, authenticator
  code      String
  verified  Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("two_factor_auth")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  code      String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@map("password_reset")
}

model SecurityAuditLog {
  id        String   @id @default(cuid())
  companyId String?
  userId    String
  eventType String   // LOGIN_SUCCESS, LOGIN_FAILED, PASSWORD_RESET_REQUESTED, etc.
  action    String?
  entityType String?
  entityId  String?
  changes   Json?
  details   String?  // JSON string for flexible event details
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("security_audit_logs")
}

model ComplianceRequirement {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  type        String   // gdpr, hipaa, pci_dss, iso27001, soc2, custom
  status      String   @default("in_progress") // compliant, non_compliant, in_progress
  requirements Json?   // Array of requirements
  dueDate     DateTime?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@map("compliance_requirements")
}

model Backup {
  id          String   @id @default(cuid())
  companyId   String
  type        String   // full, incremental, differential
  description String?
  status      String   @default("pending") // pending, in_progress, completed, failed
  size        BigInt?  // Size in bytes
  startedAt   DateTime?
  completedAt DateTime?
  createdBy   String
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  restores Restore[]

  @@index([companyId])
  @@map("backups")
}

model Restore {
  id          String   @id @default(cuid())
  companyId   String
  backupId    String
  status      String   @default("pending") // pending, in_progress, completed, failed
  targetDate  DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  initiatedBy String
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  backup  Backup  @relation(fields: [backupId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [initiatedBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([backupId])
  @@map("restores")
}

// ============================================================================
// MOBILE & CROSS-PLATFORM
// ============================================================================

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   // ios, android, web
  deviceName String?
  lastUsedAt DateTime @default(now())
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("device_tokens")
}

// ============================================================================
// AI & MACHINE LEARNING
// ============================================================================

model AIPrediction {
  id          String   @id @default(cuid())
  companyId   String
  type        String   // sales, demand, churn, revenue
  period      String   // week, month, quarter
  productId   String?
  predictions Json     // Array of predictions
  confidence  Float
  createdBy   String
  createdAt   DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("ai_predictions")
}

model AIRecommendation {
  id              String   @id @default(cuid())
  companyId       String
  type            String   // product, customer, supplier
  clientId        String?
  recommendations Json     // Array of recommendations
  score           Float
  createdBy       String
  createdAt       DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("ai_recommendations")
}

model AIAnomaly {
  id        String   @id @default(cuid())
  companyId String
  type      String   // sales, inventory, payment, customer
  anomalies Json     // Array of anomalies
  severity  String   // low, medium, high, critical
  createdBy String
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("ai_anomalies")
}

model AIConversation {
  id        String   @id @default(cuid())
  companyId String
  userId    String
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages AIMessage[]

  @@index([companyId])
  @@index([userId])
  @@map("ai_conversations")
}

model AIMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // user, assistant
  content        String   @db.Text
  createdAt      DateTime @default(now())

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("ai_messages")
}

// ============================================================================
// MONITORING & INFRASTRUCTURE
// ============================================================================

model SystemMetric {
  id         String   @id @default(cuid())
  companyId  String
  type       String   // cpu, memory, disk, network, api_response
  value      Float
  unit       String
  tags       Json     @default("{}")
  recordedAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([recordedAt])
  @@map("system_metrics")
}

model ApplicationLog {
  id         String   @id @default(cuid())
  level      String   // debug, info, warn, error, fatal
  message    String   @db.Text
  service    String
  metadata   Json     @default("{}")
  stackTrace String?  @db.Text
  timestamp  DateTime @default(now())

  @@index([level])
  @@index([service])
  @@index([timestamp])
  @@map("application_logs")
}

model DeploymentRecord {
  id          String   @id @default(cuid())
  companyId   String
  version     String
  environment String   // development, staging, production
  status      String   // pending, in_progress, success, failed
  deployedBy  String
  deployedAt  DateTime @default(now())
  completedAt DateTime?
  logs        String?  @db.Text
  error       String?  @db.Text

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [deployedBy], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([environment])
  @@index([status])
  @@map("deployment_records")
}

model BackupRecord {
  id          String   @id @default(cuid())
  companyId   String
  type        String   // full, incremental, differential
  status      String   // pending, in_progress, success, failed
  size        BigInt
  location    String
  createdAt   DateTime @default(now())
  completedAt DateTime?
  expiresAt   DateTime
  error       String?  @db.Text

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
  @@index([status])
  @@map("backup_records")
}

// ============================================================================
// REAL-TIME COLLABORATION
// ============================================================================

model CollaborationDocument {
  id            String   @id @default(cuid())
  companyId     String
  title         String
  content       String   @db.Text
  type          String   // document, spreadsheet, presentation
  ownerId       String
  version       Int      @default(1)
  collaborators String[] // Array of user IDs
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company  Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner    User                       @relation("DocumentOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  comments CollaborationComment[]
  versions CollaborationVersion[]

  @@index([companyId])
  @@index([ownerId])
  @@map("collaboration_documents")
}

model CollaborationComment {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  content    String   @db.Text
  line       Int?
  resolved   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  document CollaborationDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@map("collaboration_comments")
}

model CollaborationVersion {
  id         String   @id @default(cuid())
  documentId String
  version    Int
  content    String   @db.Text
  userId     String
  createdAt  DateTime @default(now())

  document CollaborationDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([version])
  @@map("collaboration_versions")
}

model TeamChatChannel {
  id        String   @id @default(cuid())
  companyId String
  name      String
  type      String   // public, private, direct
  members   String[] // Array of user IDs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company  Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages TeamChatMessage[]

  @@index([companyId])
  @@map("team_chat_channels")
}

model TeamChatMessage {
  id          String   @id @default(cuid())
  channelId   String
  userId      String
  content     String   @db.Text
  mentions    String[] // Array of mentioned user IDs
  attachments String[] // Array of file URLs
  reactions   Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  channel TeamChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([userId])
  @@map("team_chat_messages")
}

// ============================================================================
// SEARCH & INDEXING
// ============================================================================

model Tag {
  id        String   @id @default(cuid())
  companyId String
  name      String
  color     String?
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId])
  @@map("tags")
}

model SearchIndex {
  id        String   @id @default(cuid())
  companyId String
  type      String   // order, invoice, product, client, document
  entityId  String
  title     String
  content   String   @db.Text
  metadata  Json     @default("{}")
  indexed   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, type, entityId])
  @@index([companyId])
  @@index([type])
  @@fulltext([title, content])
  @@map("search_indexes")
}

